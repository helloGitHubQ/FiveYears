# NIO

## NIO 和 BIO

NIO和BIO的区别：

- Tomcat7 和 Tomcat8的差别。

- 硬核设置条件：4核CPU，外部 10000 个连接。如下: NIO 大概需要创建 5 个线程，而 BIO 需创建 10000 个线程。

大量的线程会带来大量的开销。


[NIO和BIO]

随着线程的不断增加，bio会越来越差，错误率和响应时间都在明显的增加。而吞吐量，每秒传输速率在不断下降。

传统的 BIO 模型：

[传统的 BIO 模型]

改造过的 BIO 模型：

[改造过的 BIO 模型]

## NIO

Non-Blocking IO

Tomcat,Dubbo,Zookeeper,RabbitMQ等都使用了 NIO.

**阻塞和非阻塞：**

- 阻塞

调用方等待操作完成后返回

- 非阻塞

调用方无需等待操作完成

**同步和异步：**

- 同步

调用者发起请求，等待操作完成再返回

- 异步

调用者发起请求，不需要等待操作完成

**扩展：**

- 同步阻塞：发送方发送请求之后一直等待响应。接收方处理请求是进行的 IO 操作如果不能马上等到返回结果，就一直等到返回结果后，才响应发送方，期间不能进行其他工作。

- 同步非阻塞：发送方发送请求之后，一直等待响应，接收方处理请求是进行的 IO 操作如果不能马上的得到结果，就立即返回，去做其他事情。但是由于没有得到请求处理结果，不响应发送方，发送方一直等待。一直等到 IO 操作完成后，接受方获得结果响应发送方后，接受方才进入下一次请求进程（实际不应用）

- 异步阻塞：发送方向接受方请求后，不等待响应，可以继续其他工作，接收方处理请求是进行 IO 操作如果不能马上得到结果，就一直等到返回结果后，才响应发送方，期间不能进行其他操作（实际不应用）

- 异步非阻塞：发送方向接受方请求后，不等待响应，可以继续其他工作，接受方处理请求时进行 IO 操作如果不能马上得到结果，也不等待，而是马上返回去做其他事情。当 IO 操作完成以后，将完成状态和结果通知接受方，接收方在响应发送方（效率最高）


		故事：小A烧开水。
		
		出场人物：小A出场道具：普通水壶（放在煤气灶上的那种，为了方便简称：水壶）；会响的水壶（水烧开了会响的那种，简称：响壶）。故事目的：小A要拿开水泡咖啡
		
		小A为了实现目的，指定了4个计划：
		
		1、用水壶烧水，并且站在煤气灶旁边，啥事不干，两眼直勾勾的盯着水壶，等水烧开。烧开后就去泡咖啡。同步阻塞
		
		假设烧水和泡咖啡是在同一个线程中执行。
		
		2、仍然用水壶煮水，不过此时不再傻傻得站在那里看水开没开，而是去玩局LOL，每当自己死了，就过来看看水开了没有。如果水开了就去泡咖啡。同步非阻塞
		
		假设这里玩LOL，是另一个线程运行的。
		
		3、动用响壶烧水，仍然站在煤气灶旁边，不过此时不两眼直勾勾的盯着壶了，而是听响，因为响壶水开时会用响声通知小A。异步阻塞
		
		4、在计划3的基础上，小A不站在煤气灶旁边了，而是去玩局LOL，等听到响壶的声音提醒后，再去跑咖啡。异步非阻塞
**五种IO模型：**

![五种IO模型](https://i.imgur.com/T1LFkEb.png)

**NIO的三大核心组件：**

- Buffer （缓冲）
- Channel （通道）
- Selector (多路复用器)
### Buffer
---
Buffer 本质上是内存的一块，我们可以将数据写入这块内存，之后从这块内存读取数据。所有的 NIO 操作始于通道，通道是数据来源或者写入数据的目的地。

[Buffer]

- Buffer 重要属性：

1. Capacity
2. position
3. limit

[Buffer的重要属性]

### Channel
---
Channel 是一个已经建立好的支持 I/O 操作的实体（如文件和网络）的连接在此连接上进行数据的读写操作，使用的缓冲区来实现读写。

数据总是从通道读取到缓冲区中，将缓冲区中的内容写到通道中。

**通道中最重要的类：**

- FileChannel：从文件中读写数据
- DatagramChannel：通过 UDP 读取网络中的数据
- SocketChannel：通过 TCP 读写网络中的数据
- ServerSocketChannel：可以监听新进来的 TCP 连接，对每一个新进来的连接都会创建一个 SocketChannel

### Selector
---

[多路复用器]

- Selector 选择器

完成主要的选择功能。select() , 并保存有注册到它上面的通道集合。

- SelectbaleChannel

可被注册到 Selector 上的通道

- SelectionKey

描述一个 Selector 和 SelectableChannel 的关系。并保存有通道所关心的操作。